name: CD-EM-RCC-InfraWorkflow

permissions:
  id-token: write
  contents: read

on:
  push:
    branches: "*"   
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      resource_path:
        description: 'Resource path (e.g., cloud-formation/rcc/a-crs-spa)'
        required: true
        type: string
      environment:
        description: 'Specific environment (leave empty for all)'
        required: false
        type: string

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    
    outputs:
      resource_paths: ${{ steps.detect-applications.outputs.paths }}
      specific_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # For workflow_dispatch events, use the input directly
      - name: Set resource path from input
        if: github.event_name == 'workflow_dispatch'
        id: set-path-from-input
        run: |
          echo "paths=${{ github.event.inputs.resource_path }}" >> $GITHUB_OUTPUT

      # For push and pull_request events, use the action to detect changes
      - name: Detect Changed Files
        if: github.event_name != 'workflow_dispatch'
        id: changed-files
        uses: younited/detect-branch-changes-action@v0.1.3
        with:
          # For push to main, compare with the previous state
          from: ${{ github.event.before }}
          to: ${{ github.sha }}
          # For pull requests, the action handles this automatically
          
      # Process the detected files to find deployment config changes
      - name: Extract Deployment Config Changes
        if: github.event_name != 'workflow_dispatch'
        id: extract-paths
        run: |
          CHANGED_PATHS=()
          
          # Get the list of changed files
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
          echo "All changed files:"
          echo "$CHANGED_FILES"
          
          # Filter for deployment config files
          echo "Filtering for deployment config files..."
          for file in $CHANGED_FILES; do
            if [[ "$file" == cloud-formation/rcc/*deployment-config.y*ml ]]; then
              RESOURCE_PATH=$(dirname "$file")
              echo "  Match found! File: $file, Resource path: $RESOURCE_PATH"
              
              if [[ ! " ${CHANGED_PATHS[@]} " =~ " ${RESOURCE_PATH} " ]]; then
                CHANGED_PATHS+=("$RESOURCE_PATH")
              fi
            fi
          done
          
          echo "Detected resource paths: ${CHANGED_PATHS[*]}"
          
          # Convert array to comma-separated string
          PATHS=$(IFS=,; echo "${CHANGED_PATHS[*]}")
          echo "Final paths output: '$PATHS'"
          echo "paths=$PATHS" >> $GITHUB_OUTPUT
      
      # Combine outputs from both potential sources
      - name: Set Final Resource Paths
        id: set-final-paths
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            FINAL_PATHS="${{ steps.set-path-from-input.outputs.paths }}"
          else
            FINAL_PATHS="${{ steps.extract-paths.outputs.paths }}"
          fi
          
          echo "paths=$FINAL_PATHS" >> $GITHUB_OUTPUT
          echo "Final resource paths to deploy: $FINAL_PATHS"
      
      # Continue with your deployment steps conditionally
      - name: Continue only if paths were detected
        id: check-paths
        run: |
          PATHS="${{ steps.set-final-paths.outputs.paths }}"
          if [[ -z "$PATHS" ]]; then
            echo "No deployment config files were changed. Skipping deployment."
            echo "should_continue=false" >> $GITHUB_OUTPUT
          else
            echo "Deployment config files were changed. Proceeding with deployment."
            echo "should_continue=true" >> $GITHUB_OUTPUT
          fi

      - name: Check Event Type and Branch
        id: check-event
        shell: bash
        run: |
          # Check if this is a pull request event
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "is_pull_request=true" >> $GITHUB_OUTPUT
          else
            echo "is_pull_request=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if this is on the main branch
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.resource_path }}" != "" ]]; then
            echo "is_main_branch=true" >> $GITHUB_OUTPUT
          else
            echo "is_main_branch=false" >> $GITHUB_OUTPUT
          fi
  prepare-matrices:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.resource_paths != '' }}
    runs-on: ubuntu-latest
    outputs:
      dev_matrix: ${{ steps.generate-matrices.outputs.dev_matrix }}
      int_matrix: ${{ steps.generate-matrices.outputs.int_matrix }}
      prod_matrix: ${{ steps.generate-matrices.outputs.prod_matrix }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate Combined Deployment Matrices
        id: generate-matrices
        uses: ./.github/actions/combined-matrix-generator
        with:
          resource_paths: ${{ needs.detect-changes.outputs.resource_paths }}
          specific_environment: ${{ needs.detect-changes.outputs.specific_environment }}

  deploy-dev:
    needs: prepare-matrices
    if: ${{ fromJSON(needs.prepare-matrices.outputs.dev_matrix).include[0] != null }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.dev_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to DEV
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets[matrix.aws_role_secret] }}
          cfn-role-arn: ${{ secrets[matrix.cfn_role_secret] }}
          iam-execution-role-arn: ${{ secrets[matrix.iam_role_secret] }}

  deploy-int:
    needs: [prepare-matrices, deploy-dev]
    if: >-
      ${{ 
        fromJSON(needs.prepare-matrices.outputs.int_matrix).include[0] != null &&
        needs.detect-changes.outputs.is_pull_request == 'false'
      }}
    runs-on: custom
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.int_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to INT
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets[matrix.aws_role_secre] }}
          cfn-role-arn: ${{ secrets.CFN_ROLE_ARN }}
          iam-execution-role-arn: ${{ secrets.IAM_EXECUTION_ROLE_ARN }}

  deploy-prod:
    needs: [prepare-matrices, deploy-int]
    if: >-
      ${{ 
        fromJSON(needs.prepare-matrices.outputs.prod_matrix).include[0] != null &&
        needs.detect-changes.outputs.is_pull_request == 'false' &&
        needs.detect-changes.outputs.is_main_branch == 'true'
      }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.prod_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to PROD
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ matrix.aws_region }}
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          cfn-role-arn: ${{ secrets.CFN_ROLE_ARN }}
          iam-execution-role-arn: ${{ secrets.IAM_EXECUTION_ROLE_ARN }}
