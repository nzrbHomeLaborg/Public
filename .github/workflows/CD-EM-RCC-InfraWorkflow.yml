name: CD-EM-RCC-InfraWorkflow

permissions:
  id-token: write
  contents: read

on:
  push:
    branches: [main]   
  pull_request:
    branches: [develop]
  workflow_dispatch:
    inputs:
      resource_path:
        description: 'Resource path (e.g., cloud-formation/rcc/a-crs-spa)'
        required: true
        type: string
      environment:
        description: 'Specific environment (leave empty for all)'
        required: false
        type: string

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    
    outputs:
      resource_paths: ${{ steps.detect-applications.outputs.paths }}
      specific_environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # For workflow_dispatch events, use the input directly
      - name: Set resource path from input
        if: github.event_name == 'workflow_dispatch'
        id: set-path-from-input
        run: |
          echo "paths=${{ github.event.inputs.resource_path }}" >> $GITHUB_OUTPUT

      # For push and pull_request events, use the action to detect changes
      - name: Detect Changed Files
        if: github.event_name != 'workflow_dispatch'
        id: changed-files
        uses: younited/detect-branch-changes-action@v0.1.3
        with:
          # For push to main, compare with the previous state
          from: ${{ github.event.before }}
          to: ${{ github.sha }}
          # For pull requests, the action handles this automatically
          
      # Process the detected files to find deployment config changes
      - name: Detect Changed Applications
        id: detect-applications
        shell: bash
        run: |
          # For workflow_dispatch events
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "paths=${{ github.event.inputs.resource_path }}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          CHANGED_PATHS=()
          CHANGED_FILES=""
          
          # Get the base and head commits for comparison
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For PR events, compare base to head
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "Getting changed files for PR #$PR_NUMBER"
            
            CHANGED_FILES=$(curl -s -H "Authorization: token ${{ github.token }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" | \
              jq -r '.[].filename')
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # For push events (including merges to main)
            echo "Push event detected"
            
            # Check if this is a merge commit by counting parents
            PARENT_COUNT=$(git cat-file -p ${{ github.sha }} | grep -c "^parent ")
            
            if [[ $PARENT_COUNT -gt 1 ]]; then
              echo "Merge commit detected with $PARENT_COUNT parents"
              
              # For merge commits, compare the merge base to the current commit
              # This finds all files that changed between the common ancestor and the current state
              MERGE_BASE=$(git merge-base ${{ github.event.before }} ${{ github.sha }})
              echo "Merge base is $MERGE_BASE"
              
              CHANGED_FILES=$(git diff --name-only $MERGE_BASE ${{ github.sha }})
            else
              # Normal push, get files changed in this commit
              echo "Regular push detected"
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
              
              # If no files found, try using the commit range
              if [[ -z "$CHANGED_FILES" ]]; then
                echo "No files found with direct comparison, trying commit range..."
                CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }})
              fi
            fi
          else
            # Fallback for other events
            echo "Event type: ${{ github.event_name }}"
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
          fi
          
          echo "All changed files being considered:"
          echo "$CHANGED_FILES"
          
          echo "Filtering for deployment config files..."
          while read -r file; do
            # Skip empty lines
            [[ -z "$file" ]] && continue
            
            # Check if the file is a deployment config file
            if [[ "$file" == cloud-formation/rcc/*deployment-config.y*ml ]]; then
              # Extract the resource path
              RESOURCE_PATH=$(dirname "$file")
              echo "  Match found! File: $file, Resource path: $RESOURCE_PATH"
              
              if [[ ! " ${CHANGED_PATHS[@]} " =~ " ${RESOURCE_PATH} " ]]; then
                CHANGED_PATHS+=("$RESOURCE_PATH")
              fi
            fi
          done <<< "$CHANGED_FILES"
          
          echo "Detected resource paths: ${CHANGED_PATHS[*]}"
          
          # Convert array to comma-separated string
          PATHS=$(IFS=,; echo "${CHANGED_PATHS[*]}")
          echo "Final paths output: '$PATHS'"
          echo "paths=$PATHS" >> $GITHUB_OUTPUT
          
          # Debug info for empty results
          if [[ -z "$PATHS" ]]; then
            echo "No paths detected. Here's some debug information:"
            echo "Event name: ${{ github.event_name }}"
            echo "Ref: ${{ github.ref }}"
            echo "Base ref: ${{ github.event.pull_request.base.ref || 'N/A' }}"
            echo "SHA: ${{ github.sha }}"
            echo "Before: ${{ github.event.before || 'N/A' }}"
            echo "After: ${{ github.event.after || 'N/A' }}"
          fi
  prepare-matrices:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.resource_paths != '' }}
    runs-on: ubuntu-latest
    outputs:
      dev_matrix: ${{ steps.generate-matrices.outputs.dev_matrix }}
      int_matrix: ${{ steps.generate-matrices.outputs.int_matrix }}
      prod_matrix: ${{ steps.generate-matrices.outputs.prod_matrix }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Generate Combined Deployment Matrices
        id: generate-matrices
        uses: ./.github/actions/combined-matrix-generator
        with:
          resource_paths: ${{ needs.detect-changes.outputs.resource_paths }}
          specific_environment: ${{ needs.detect-changes.outputs.specific_environment }}

  deploy-dev:
    needs: prepare-matrices
    if: ${{ fromJSON(needs.prepare-matrices.outputs.dev_matrix).include[0] != null }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.dev_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to DEV
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets[matrix.aws_role_secret] }}
          cfn-role-arn: ${{ secrets[matrix.cfn_role_secret] }}
          iam-execution-role-arn: ${{ secrets[matrix.iam_role_secret] }}

  deploy-int:
    needs: [prepare-matrices, deploy-dev]
    if: >-
      ${{ 
        fromJSON(needs.prepare-matrices.outputs.int_matrix).include[0] != null &&
        needs.detect-changes.outputs.is_pull_request == 'false'
      }}
    runs-on: custom
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.int_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to INT
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets[matrix.aws_role_secre] }}
          cfn-role-arn: ${{ secrets.CFN_ROLE_ARN }}
          iam-execution-role-arn: ${{ secrets.IAM_EXECUTION_ROLE_ARN }}

  deploy-prod:
    needs: [prepare-matrices, deploy-int]
    if: >-
      ${{ 
        fromJSON(needs.prepare-matrices.outputs.prod_matrix).include[0] != null &&
        needs.detect-changes.outputs.is_pull_request == 'false' &&
        needs.detect-changes.outputs.is_main_branch == 'true'
      }}
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.prepare-matrices.outputs.prod_matrix) }}
      fail-fast: false
    environment: ${{ matrix.github_environment }}
    
    name: Deploy ${{ matrix.application }}-${{ matrix.resource }} to PROD
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ matrix.aws_region }}
      
      - name: Deploy Stack
        uses: ./.github/actions/deploy-stack
        with:
          environment: ${{ matrix.environment }}
          stack-name: ${{ matrix.parameters.stack-name }}
          bucket-name: ${{ matrix.parameters.bucket-name }}
          upload-to-s3: ${{ matrix.parameters.bucket-upload }}
          target-folder: ${{ matrix.parameters.target-folder }}
          source-folder: ${{ matrix.parameters.source-folder }}
          template-name: ${{ matrix.parameters.template-name }}
          filename-patterns: ${{ matrix.parameters.filename-patterns }}
          cfnLintEnabled: ${{ matrix.parameters.cfnLintEnabled }}
          extraArgs: ${{ matrix.parameters.extraArgs }}          
          parameter-file: ${{ matrix.parameters.parameter-file }}
          inline-parameters: ${{ toJSON(matrix.parameters.inline-parameters) }}
          tags: ${{ matrix.parameters.tags }}
          aws-region: ${{ matrix.aws_region }}
          aws-role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          cfn-role-arn: ${{ secrets.CFN_ROLE_ARN }}
          iam-execution-role-arn: ${{ secrets.IAM_EXECUTION_ROLE_ARN }}
